<!doctype html>
<html lang="pl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Elephant Coffee ‚Äî Gra</title>
    <style>
        :root {
            --brand: #ffd7b3;
            --gold: #ffd700;
            --text: #fff;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: #000;
            color: var(--text);
            font-family: Inter, system-ui, sans-serif;
        }

        body {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .app {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            /* —Ñ–æ–Ω –∏–≥—Ä—ã —Ç–µ–ø–µ—Ä—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –∏–∑ CONFIG.ui.background */
            background: #0f0f0f;
        }

        .safe {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 14px;
            padding-top: calc(env(safe-area-inset-top) + 14px);
            display: flex;
            justify-content: space-between;
            z-index: 5;
            font-weight: 700;
        }

        .pill {
            background: rgba(0, 0, 0, .45);
            border: 1px solid #333;
            border-radius: 999px;
            padding: 6px 12px;
        }

        .logo,
        .super,
        .bomb,
        .big,
        .tornado {
            position: absolute;
            top: -80px;
            width: 56px;
            height: 56px;
            object-fit: contain;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
            will-change: transform, left, top;
            filter: brightness(1.12) contrast(1.06) drop-shadow(0 10px 14px rgba(0, 0, 0, .65));
        }

        .super {
            border-radius: 50%;
            box-shadow: 0 0 0 3px var(--gold), 0 0 14px var(--gold), 0 0 22px rgba(255, 215, 0, .35);
        }

        .big {
            filter: drop-shadow(0 10px 18px rgba(0, 0, 0, .55)) drop-shadow(0 0 14px rgba(255, 215, 179, .25));
            width: 180px;
            height: 180px;
        }

        .bomb {
            font-size: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            filter: drop-shadow(0 10px 14px rgba(0, 0, 0, .65));
        }

        @keyframes fall {
            to {
                transform: translateY(calc(100vh + 140px)) rotate(var(--rot, 0deg));
            }
        }

        @keyframes tilt {
            0% {
                transform: rotate(-6deg)
            }

            50% {
                transform: rotate(6deg)
            }

            100% {
                transform: rotate(-6deg)
            }
        }

        .logo,
        .super {
            animation-name: fall, tilt;
            animation-duration: var(--fallDur, 2000ms), 2.2s;
            animation-timing-function: linear, ease-in-out;
            animation-iteration-count: 1, infinite;
        }

        .logo {
            width: 96px;
            height: 96px;
        }

        .big {
            animation-name: fall, tilt;
            animation-duration: var(--fallDur, 2200ms), 2.4s;
            animation-timing-function: linear, ease-in-out;
            animation-iteration-count: 1, infinite;
        }

        .overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, .65);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .modal {
            text-align: center;
            max-width: 90%;
        }

        .btn {
            background: var(--brand);
            border: none;
            border-radius: 999px;
            padding: 12px 24px;
            font-weight: 800;
            cursor: pointer;
        }

        .sheet {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            background: #111;
            padding: 20px;
            border-top-left-radius: 18px;
            border-top-right-radius: 18px;
            z-index: 20;
            box-shadow: 0 -12px 30px rgba(0, 0, 0, .4);
        }

        .ring {
            position: absolute;
            width: 14px;
            height: 14px;
            border: 3px solid var(--brand);
            border-radius: 999px;
            pointer-events: none;
            opacity: .9;
            transform: translate(-50%, -50%) scale(.3);
            animation: ring .5s ease-out forwards;
        }

        @keyframes ring {
            to {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1.8);
            }
        }

        .float {
            position: absolute;
            left: 0;
            top: 0;
            transform: translate(-50%, -50%);
            color: var(--gold);
            font-weight: 900;
            text-shadow: 0 2px 10px rgba(0, 0, 0, .5);
            pointer-events: none;
            animation: floatUp .9s ease-out forwards;
        }

        @keyframes floatUp {
            0% {
                opacity: 0;
                transform: translate(-50%, -30%) scale(.6)
            }

            20% {
                opacity: 1
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -120%) scale(1.1)
            }
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 12px;
            border-radius: 5px;
            pointer-events: none;
            animation: confDrop 1.2s ease-out forwards;
        }

        @keyframes confDrop {
            to {
                transform: translate(var(--dx), var(--dy)) rotate(var(--rot));
                opacity: 0;
            }
        }

        .boom {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 70%;
            pointer-events: none;
            background: radial-gradient(circle, rgba(255, 220, 150, .95) 0%, rgba(255, 120, 0, .7) 45%, rgba(0, 0, 0, 0) 70%);
            transform: translate(-50%, -50%) scale(.5);
            opacity: .95;
            box-shadow: 0 0 20px rgba(255, 140, 0, .8), 0 0 40px rgba(255, 100, 0, .6);
            animation: boom 1s ease-out forwards;
        }

        @keyframes boom {
            60% {
                transform: translate(-50%, -50%) scale(8);
                opacity: .85;
            }

            100% {
                transform: translate(-50%, -50%) scale(8);
                opacity: 0;
            }
        }

        .shake {
            animation: shake 450ms cubic-bezier(.36, .07, .19, .97);
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate(-1px, 0)
            }

            20%,
            80% {
                transform: translate(2px, 0)
            }

            30%,
            50%,
            70% {
                transform: translate(-4px, 0)
            }

            40%,
            60% {
                transform: translate(4px, 0)
            }
        }

        .wind {
            animation: wind .45s ease-in-out;
        }

        @keyframes wind {
            0% {
                transform: translateX(0)
            }

            25% {
                transform: translateX(-6px)
            }

            50% {
                transform: translateX(6px)
            }

            75% {
                transform: translateX(-3px)
            }

            100% {
                transform: translateX(0)
            }
        }

        .crit-flash {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle, rgba(255, 255, 255, .14), rgba(255, 255, 255, 0) 60%);
            pointer-events: none;
            animation: critFlash .35s ease-out forwards;
            z-index: 9;
        }

        @keyframes critFlash {
            from {
                opacity: .9
            }

            to {
                opacity: 0
            }
        }

        .crit-burst {
            position: absolute;
            width: 42px;
            height: 42px;
            border-radius: 999px;
            background: radial-gradient(circle, rgba(255, 215, 179, .95) 0%, rgba(255, 200, 120, .65) 45%, rgba(0, 0, 0, 0) 70%);
            box-shadow: 0 0 30px rgba(255, 200, 120, .9), 0 0 60px rgba(255, 160, 60, .7);
            transform: translate(-50%, -50%) scale(.6);
            opacity: .95;
            pointer-events: none;
            z-index: 8;
            animation: critBurst .9s ease-out forwards;
        }

        @keyframes critBurst {
            60% {
                transform: translate(-50%, -50%) scale(10);
                opacity: .85;
            }

            100% {
                transform: translate(-50%, -50%) scale(10);
                opacity: 0;
            }
        }

        .crit-ray {
            position: absolute;
            width: 6px;
            height: 26px;
            border-radius: 3px;
            background: linear-gradient(to bottom, rgba(255, 215, 179, 1), rgba(255, 215, 179, 0));
            transform-origin: center bottom;
            opacity: .95;
            pointer-events: none;
            z-index: 8;
            animation: critRay .7s ease-out forwards;
        }

        @keyframes critRay {
            60% {
                transform: translate(-50%, -50%) rotate(var(--rot)) scaleY(1.5);
                opacity: .9;
            }

            100% {
                transform: translate(-50%, -50%) rotate(var(--rot)) scaleY(1.5) translateY(-24px);
                opacity: 0;
            }
        }

        .tornado {
            width: 62px;
            height: 62px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fall var(--fallDur, 2200ms) linear forwards, spin 1.2s linear infinite, spawnFade .25s ease-out forwards;
            filter: drop-shadow(0 0 22px rgba(150, 200, 255, .6));
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes spawnFade {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        .twist {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 6px solid rgba(160, 200, 255, .85);
            opacity: .9;
            transform: translate(-50%, -50%) scale(.9);
            pointer-events: none;
            animation: twistOut .55s ease-out forwards;
            box-shadow: 0 0 10px rgba(140, 190, 255, .7);
        }

        .app::before {
            content: "";
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.55);
            pointer-events: none;
            z-index: 0;
        }

        @keyframes twistOut {
            70% {
                transform: translate(var(--dx), var(--dy)) scale(1.35);
                opacity: .7;
            }

            100% {
                transform: translate(var(--dx), var(--dy)) scale(1.35);
                opacity: 0;
            }
        }

        .vortex {
            position: absolute;
            left: 0;
            top: 0;
            pointer-events: none;
            width: 82px;
            height: 82px;
            border-radius: 50%;
            background: radial-gradient(circle at 50% 50%, rgba(170, 210, 255, .25), rgba(170, 210, 255, 0) 65%);
            box-shadow: 0 0 42px rgba(150, 200, 255, .45), inset 0 0 14px rgba(180, 220, 255, .35);
            transform: translate(-50%, -50%) scale(.6) rotate(0deg);
            animation: vortexSpin .9s ease-out forwards;
        }

        @keyframes vortexSpin {
            60% {
                transform: translate(-50%, -50%) scale(2.8) rotate(220deg);
                opacity: .9;
            }

            100% {
                transform: translate(-50%, -50%) scale(3) rotate(260deg);
                opacity: 0;
            }
        }

        .text-main {
            font-size: 20px;
            line-height: 1.55;
            color: #f3eee9;
            text-shadow: 0 1px 4px rgba(0, 0, 0, 0.45);
            font-weight: 400;
        }

        .text-list li {
            margin: 8px 0;
            font-size: 18px;
            color: #ffffffd8;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }

        .text-strong {
            font-weight: 700;
            color: #ffd7b3;
        }

        .text-muted {
            opacity: .88;
        }

        .text-title-small {
            font-size: 17px;
            color: #ffe5c7;
            font-weight: 600;
            margin-bottom: 6px;
            text-shadow: 0 1px 4px rgba(0, 0, 0, .5);
        }

        /* --- ROMA (—Ç–≤–æ–π ¬´—Å—É–ø–µ—Ä-–æ–±—ä–µ–∫—Ç¬ª) ‚Äî –æ—Ä–∞–Ω–∂–µ–≤–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∏ 84px --- */
        .roma {
            position: absolute;
            top: -80px;
            width: 84px;
            height: 84px;
            object-fit: contain;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
            border-radius: 50%;
            /* —Ç—ë–ø–ª–∞—è –æ—Ä–∞–Ω–∂–µ–≤–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ */
            filter: drop-shadow(0 10px 18px rgba(0, 0, 0, .55)) drop-shadow(0 0 22px rgba(255, 168, 77, .45));
            box-shadow: 0 0 0 3px #ffa84d, 0 0 16px #ffa84d, 0 0 28px rgba(255, 168, 77, .55);
            animation-name: fall, tilt;
            animation-duration: var(--fallDur, 2000ms), 2.2s;
            animation-timing-function: linear, ease-in-out;
            animation-iteration-count: 1, infinite;
        }

        /* --- SLOWMO: –∑–∞–º–µ–¥–ª—è–µ–º –ø–∞–¥–µ–Ω–∏–µ —É –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤ --- */
        .app.slowmo .logo,
        .app.slowmo .super,
        .app.slowmo .big,
        .app.slowmo .tornado,
        .app.slowmo .bomb,
        .app.slowmo .roma {
            animation-duration: calc(var(--fallDur, 2000ms) * 2.8), 2.2s !important;
        }

        /* –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –ø–æ–≤–µ—Ä—Ö —Å—Ü–µ–Ω—ã –≤ —Å–ª–æ—É–º–æ */
        .app.slowmo::after {
            content: "";
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, .22);
            pointer-events: none;
            z-index: 9;
        }

        /* === PRISM FX –¥–ª—è ROMA (–ù–æ–≤—ã–π —ç—Ñ—Ñ–µ–∫—Ç) === */
        .prism-core {
            position: absolute;
            left: 0;
            top: 0;
            transform: translate(-50%, -50%) scale(.6);
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background:
                radial-gradient(circle at 50% 50%, rgba(255, 255, 255, .95) 0%, rgba(255, 255, 255, 0) 55%),
                conic-gradient(from 0deg, #ffd7b3, #ffd700, #ff8a00, #ff4d4d, #b36bff, #66d9ff, #ffd7b3);
            box-shadow: 0 0 24px rgba(255, 215, 179, .9), 0 0 60px rgba(255, 215, 0, .45);
            pointer-events: none;
            z-index: 9;
            animation: prismPulse .9s ease-out forwards, prismSpin 1.4s linear;
        }

        @keyframes prismPulse {
            60% {
                transform: translate(-50%, -50%) scale(1.4);
                opacity: .95;
            }

            100% {
                transform: translate(-50%, -50%) scale(1.6);
                opacity: 0;
            }
        }

        @keyframes prismSpin {
            to {
                filter: hue-rotate(360deg)
            }
        }

        .prism-shard {
            position: absolute;
            left: 0;
            top: 0;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 18px;
            border-radius: 2px;
            background: linear-gradient(180deg, rgba(255, 255, 255, .95), rgba(255, 255, 255, 0));
            box-shadow: 0 0 14px rgba(255, 255, 255, .65);
            pointer-events: none;
            z-index: 9;
            animation: shardFly .9s ease-out forwards;
        }

        @keyframes shardFly {
            75% {
                transform: translate(var(--dx), var(--dy)) rotate(var(--rot)) scale(1.2);
                opacity: .9;
            }

            100% {
                transform: translate(calc(var(--dx)*1.25), calc(var(--dy)*1.25)) rotate(var(--rot)) scale(1.2);
                opacity: 0;
            }
        }

        .prism-halo {
            position: absolute;
            left: 0;
            top: 0;
            transform: translate(-50%, -50%) scale(.5);
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid rgba(255, 215, 179, .9);
            box-shadow: 0 0 30px rgba(255, 215, 179, .8), 0 0 60px rgba(255, 215, 0, .35);
            pointer-events: none;
            z-index: 8;
            animation: haloExpand .8s ease-out forwards;
        }

        @keyframes haloExpand {
            70% {
                transform: translate(-50%, -50%) scale(2.4);
                opacity: .8;
            }

            100% {
                transform: translate(-50%, -50%) scale(2.6);
                opacity: 0;
            }
        }

        .prism-trail {
            position: absolute;
            left: 0;
            top: 0;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: radial-gradient(circle, #fff, rgba(255, 255, 255, 0));
            box-shadow: 0 0 10px #fff;
            pointer-events: none;
            z-index: 8;
            animation: trailFade .6s ease-out forwards;
        }

        @keyframes trailFade {
            100% {
                transform: translate(var(--dx), var(--dy));
                opacity: 0;
            }
        }

        /* –ª—ë–≥–∫–∞—è –≤–∏–Ω—å–µ—Ç–∫–∞ –ø—Ä–∏ —Å–ª–æ—É–º–æ */
        .app.slowmo .freeze-vignette {
            content: "";
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 10;
            background: radial-gradient(circle at 50% 50%, rgba(0, 0, 0, 0) 55%, rgba(0, 0, 0, .28) 100%);
            animation: vignetteBlink .25s ease-out;
        }

        @keyframes vignetteBlink {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }
    </style>
</head>

<body>
    <div class="app" id="app">
        <div class="safe">
            <div class="pill">Czas: <b id="time">15.0</b>s</div>
            <div class="pill">Rabat: <b id="discount">0 z≈Ç</b></div>
        </div>
        <div class="overlay" id="startOv">
            <div class="modal">
                <h1 class="title-anim" style="
                    font-size:32px;
                    font-weight:900;
                    background: linear-gradient(90deg,#ffd7b3,#ffe9c8);
                    -webkit-background-clip: text;
                    color: transparent;
                    text-shadow:0 2px 8px rgba(0,0,0,.45);
                ">
                    Gra od Elephant Coffee ‚Äî Z≈ÅAP S≈ÅONIA üêò
                </h1></br></br>
                <p style="opacity:.9;line-height:1.4;font-size:18px;">
                    Cze≈õƒá! Gra jest w wersji testowej ‚Äî nagrody bƒôdƒÖ aktywne po oficjalnym starcie ü´∂
                </p>
                <p style="opacity:.9;line-height:1.4" id="rulesText"></p>
                <button class="btn" id="start">Graj!</button>
            </div>
        </div>
    </div>

    <script>
        /* =========================================================
           ‚öôÔ∏è CONFIG ‚Äî –≤—Å—ë –º–µ–Ω—è–µ–º –∑–¥–µ—Å—å
           ========================================================= */
        const CONFIG = {
            game: {
                duration: 15000,
                spawnInterval: 175,
                fallMin: 1800,
                fallMax: 2800,
                cap: 10,           // —Ç–µ–ø–µ—Ä—å —ç—Ç–æ –ª–∏–º–∏—Ç –≤ z≈Ç
                chSwim: 0.35,
                chEvade: 0.26
            },

            /* üé® –§–æ–Ω –∏–≥—Ä—ã */
            ui: {
                /*background: '#0f0f0f'*/
                background: 'url(./background.jpg) center center / cover no-repeat #000'
            },

            /* üéµ –ó–≤—É–∫–∏ */
            sounds: {
                enabled: true,
                bg: { src: 'background.mp3', volume: 0.35 },
                hit: { src: './hit.mp3', volume: 0.45, pool: 6 },
                bomb: { src: 'bomb.mp3', volume: 0.7 },
                tornado: { src: './tornado.mp3', volume: 0.6 }
            },

            /* üß© –≠–ª–µ–º–µ–Ω—Ç—ã + –∑–≤—É–∫–∏ */
            elements: {
                normal: {
                    reward: 0.1,
                    allowEvade: true,
                    allowSwim: true,
                    sound: { src: './basic.mp3', volume: 0.5, pool: 4 },
                    items: [
                        { src: 'basic.png', size: 56, note: '–ë—Ä–∞–∑–∏–ª–∏—è 250–≥', sound: { src: './pack250.mp3', volume: 0.55, pool: 3 } },
                        { src: 'basic.png', size: 56, note: 'Balance 70/30' },
                        { src: 'basic.png', size: 56, note: 'Brazil Santos' },
                        { src: 'basic.png', size: 56, note: 'Alternative' }
                    ],
                    fallbackSvg:
                        `<svg xmlns='http://www.w3.org/2000/svg' width='56' height='56'><rect x='5' y='5' width='46' height='46' rx='8' fill='#ffd7b3'/></svg>`
                },

                super: {
                    reward: 0.80, size: 56, src: './logo.png', chance: 0.30, maxPerGame: 3,
                    allowEvade: true, allowSwim: true,
                    sound: { src: './super.mp3', volume: 0.7 },
                    fallbackSvg:
                        `<svg xmlns='http://www.w3.org/2000/svg' width='56' height='56'><circle cx='28' cy='28' r='26' fill='#ffd7b3'/></svg>`
                },

                big: {
                    reward: 0.5, size: 185, src: './big.png', chance: 0.30, maxPerGame: 3,
                    allowEvade: true, allowSwim: true,
                    sound: { src: './hit.mp3', volume: 0.75 }
                },

                bomb: {
                    reward: -3.0, size: 65, chance: 0.25,
                    icon: 'üí£', imageSrc: '', allowEvade: false, allowSwim: true,
                    sound: { src: './bomb.mp3', volume: 0.7 }
                },

                tornado: {
                    reward: -0.4, size: 62, chance: 0.05, src: 'tornado.png',
                    allowEvade: true, allowSwim: true,
                    pull: { radius: 240, strength: 60, dur: 620 },
                    vibr: [40, 20, 60],
                    sound: { src: './tornado.mp3', volume: 0.2 }
                },

                /* üêò ROMA ‚Äî —Ç–≤–æ–π —Å—É–ø–µ—Ä-–æ–±—ä–µ–∫—Ç (–∑–∞–º–µ–¥–ª—è–µ—Ç –≤—Ä–µ–º—è) */
                roma: {
                    reward: 0.0,        // –æ—á–∫–∏ –Ω–µ –¥–∞—ë–º ‚Äî —ç—Ñ—Ñ–µ–∫—Ç slow-mo
                    size: 84,
                    src: './roma.png',  // <--- –ø–æ–ª–æ–∂–∏ —Ñ–∞–π–ª roma.png —Ä—è–¥–æ–º —Å —ç—Ç–∏–º HTML
                    chance: 0.25,
                    maxPerGame: 1,      // –æ–¥–∏–Ω —Ä–∞–∑ –∑–∞ —Ä–∞—É–Ω–¥
                    allowEvade: false,
                    allowSwim: true,
                    // —Å–≤–æ–π –º–µ–¥–ª–µ–Ω–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –ø–∞–¥–µ–Ω–∏—è
                    fallMin: 2400,
                    fallMax: 3600,
                    sound: { src: './roma.mp3', volume: 0.7 },
                    fallbackSvg:
                        `<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><circle cx='32' cy='32' r='30' fill='#ffd7b3'/></svg>`
                }
            },

            vib: { normal: 18, super: 26, bomb: [80, 40, 120] }
        };
        /* ========================= END CONFIG ========================= */

        /* ========= –£—Ç–∏–ª–∏—Ç—ã ========= */
        const app = document.getElementById('app');
        const dEl = document.getElementById('discount');
        const tEl = document.getElementById('time');
        const startOv = document.getElementById('startOv');

        // —Ñ–æ—Ä–º–∞—Ç z≈Ç –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
        const zl = v => new Intl.NumberFormat('pl-PL', {
            style: 'currency',
            currency: 'PLN',
            maximumFractionDigits: (Math.abs(v) % 1 === 0 ? 0 : 2)
        }).format(v);

        const vibr = p => { if (!p) return; if (navigator.vibrate) try { navigator.vibrate(p) } catch (_) { } };
        const rand = (a, b) => Math.random() * (b - a) + a;
        const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

        let running = false, discount = 0, superCount = 0, bigCount = 0, t0 = 0, spawnTimer = null;

        /* ========= –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–æ–Ω –∏–∑ CONFIG ========= */
        (function applyBackground() {
            if (CONFIG?.ui?.background) app.style.background = CONFIG.ui.background;
        })();

        /* ========= –ü—Ä–∞–≤–∏–ª–∞ –∏–∑ CONFIG (–≤ z≈Ç) ========= */
        (function setRules() {
            const E = CONFIG.elements;
            const txt = [
                `‚Ä¢ Paczka kawy = <b>+${zl(E.normal.reward)}</b>`,
                `‚Ä¢ Super S≈Ço≈Ñ Logo = <b>+${zl(E.super.reward)}</b>`,
                `‚Ä¢ Paczka z RƒôkƒÖ = <b>+${zl(E.big.reward)}</b>`,
                `üí£ Bomba = <b>${zl(E.bomb.reward)}</b>`,
                `‚Ä¢ Zestaw trzech kaw = <b>${zl(E.tornado.reward)}</b>`,
                `‚Ä¢ Z≈Çap mnie ‚Äî spowolnienie czasu na <b>3 sekundy</b>`

            ].join('<br>');
            document.getElementById('rulesText').innerHTML = txt;
        })();

        /* ========= –ê—É–¥–∏–æ ========= */
        const SND = {}; let __idx = 0; let bgMusic = null;
        function regSound(key, cfg) {
            if (!cfg || !cfg.src) return;
            const { src, volume = 1, pool = 1 } = cfg;
            if (pool > 1) { SND[key] = Array.from({ length: pool }, () => { const a = new Audio(src); a.volume = volume; a.preload = 'auto'; return a; }); }
            else { const a = new Audio(src); a.volume = volume; a.preload = 'auto'; SND[key] = a; }
        }
        function play(key) {
            if (!CONFIG.sounds.enabled) return; const s = SND[key]; if (!s) return;
            if (Array.isArray(s)) { const a = s[(__idx++ % s.length)]; try { a.currentTime = 0; a.play(); } catch { } }
            else { try { s.currentTime = 0; s.play(); } catch { } }
        }
        (function setupAudio() {
            if (!CONFIG.sounds.enabled) return;
            const SS = CONFIG.sounds;
            if (SS.bg && SS.bg.src) { bgMusic = new Audio(SS.bg.src); bgMusic.loop = true; bgMusic.volume = SS.bg.volume ?? 1; bgMusic.preload = 'auto'; }
            regSound('hit', SS.hit); regSound('bomb', SS.bomb); regSound('tornado', SS.tornado);
            const E = CONFIG.elements;
            regSound('el.normal', E.normal.sound);
            regSound('el.super', E.super.sound);
            regSound('el.big', E.big.sound);
            regSound('el.bomb', E.bomb.sound);
            regSound('el.tornado', E.tornado.sound);
            regSound('el.roma', E.roma.sound);
            (E.normal.items || []).forEach((it, i) => regSound(`el.normal.${i}`, it.sound));
        })();

        /* ========= UI-—ç—Ñ—Ñ–µ–∫—Ç—ã ========= */
        function ring(x, y) { const r = document.createElement('div'); r.className = 'ring'; r.style.left = x + 'px'; r.style.top = y + 'px'; app.appendChild(r); setTimeout(() => r.remove(), 520); }
        function confetti(x, y, n = 14) {
            const colors = ['#ffd7b3', '#ffd700', '#ffa84d', '#ffffff'];
            for (let i = 0; i < n; i++) {
                const c = document.createElement('div'); c.className = 'confetti'; c.style.left = x + 'px'; c.style.top = y + 'px';
                c.style.background = colors[Math.floor(Math.random() * colors.length)];
                const dx = (Math.random() < .5 ? -1 : 1) * (20 + Math.random() * 60), dy = -(20 + Math.random() * 60), rot = (Math.random() < .5 ? -1 : 1) * (120 + Math.random() * 180) + 'deg';
                c.style.setProperty('--dx', dx + 'px'); c.style.setProperty('--dy', dy + 'px'); c.style.setProperty('--rot', rot);
                app.appendChild(c); setTimeout(() => c.remove(), 1000);
            }
        }
        function floatLabel(x, y, text) { const f = document.createElement('div'); f.className = 'float'; f.textContent = text; f.style.left = x + 'px'; f.style.top = y + 'px'; app.appendChild(f); setTimeout(() => f.remove(), 900); }
        const celebrate = (x, y, text) => { ring(x, y); confetti(x, y); floatLabel(x, y, text); };
        function boom(x, y) { const b = document.createElement('div'); b.className = 'boom'; b.style.left = x + 'px'; b.style.top = y + 'px'; app.appendChild(b); setTimeout(() => b.remove(), 650); }
        function shake() { app.classList.remove('shake'); void app.offsetWidth; app.classList.add('shake'); }
        function windGust() { app.classList.remove('wind'); void app.offsetWidth; app.classList.add('wind'); }

        const CRIT_CONFETTI = 28, CRIT_RAYS = 10, CRIT_VIB = 40;
        function confettiRich(x, y, amount = 24) {
            const colors = ['#ffd7b3', '#ffd700', '#ffa84d', '#fff5da', '#ffffff'];
            for (let i = 0; i < amount; i++) {
                const c = document.createElement('div'); c.className = 'confetti'; c.style.left = x + 'px'; c.style.top = y + 'px';
                c.style.background = colors[Math.floor(Math.random() * colors.length)];
                const dx = (Math.random() < .5 ? -1 : 1) * (30 + Math.random() * 80), dy = -(30 + Math.random() * 80), rot = (Math.random() < .5 ? -1 : 1) * (140 + Math.random() * 220) + 'deg';
                c.style.setProperty('--dx', dx + 'px'); c.style.setProperty('--dy', dy + 'px'); c.style.setProperty('--rot', rot);
                app.appendChild(c); setTimeout(() => c.remove(), 1000);
            }
        }
        function critCelebrate(x, y, text) {
            ring(x, y); confettiRich(x, y, CRIT_CONFETTI); floatLabel(x, y, text);
            const b = document.createElement('div'); b.className = 'crit-burst'; b.style.left = x + 'px'; b.style.top = y + 'px'; app.appendChild(b); setTimeout(() => b.remove(), 720);
            for (let i = 0; i < CRIT_RAYS; i++) {
                const r = document.createElement('div'); r.className = 'crit-ray'; r.style.left = x + 'px'; r.style.top = y + 'px';
                const base = (360 / CRIT_RAYS) * i, jitter = (Math.random() * 18) - 9; r.style.setProperty('--rot', (base + jitter) + 'deg'); app.appendChild(r); setTimeout(() => r.remove(), 720);
            }
            const f = document.createElement('div'); f.className = 'crit-flash'; app.appendChild(f); setTimeout(() => f.remove(), 360);
        }
        function twistBurst(x, y, n = 8) {
            for (let i = 0; i < n; i++) {
                const t = document.createElement('div'); t.className = 'twist'; t.style.left = x + 'px'; t.style.top = y + 'px';
                const ang = (Math.PI * 2 / n) * i + (Math.random() * 0.6 - 0.3), r = 26 + Math.random() * 24;
                t.style.setProperty('--dx', (Math.cos(ang) * r) + 'px'); t.style.setProperty('--dy', (Math.sin(ang) * r) + 'px');
                app.appendChild(t); setTimeout(() => t.remove(), 560);
            }
        }
        function vortex(x, y) { const v = document.createElement('div'); v.className = 'vortex'; v.style.left = x + 'px'; v.style.top = y + 'px'; app.appendChild(v); setTimeout(() => v.remove(), 620); }

        /* === PRISM FX –¥–ª—è ROMA === */
        function romaPrismFX(x, y) {
            // core
            const core = document.createElement('div');
            core.className = 'prism-core';
            core.style.left = x + 'px'; core.style.top = y + 'px';
            app.appendChild(core);
            setTimeout(() => core.remove(), 720);

            // halo
            const halo = document.createElement('div');
            halo.className = 'prism-halo';
            halo.style.left = x + 'px'; halo.style.top = y + 'px';
            app.appendChild(halo);
            setTimeout(() => halo.remove(), 820);

            // shards
            const shards = 26;
            for (let i = 0; i < shards; i++) {
                const s = document.createElement('div');
                s.className = 'prism-shard';
                s.style.left = x + 'px'; s.style.top = y + 'px';
                const ang = (i / shards) * Math.PI * 2 + (Math.random() * 0.35 - 0.175);
                const r = 60 + Math.random() * 110;
                const dx = Math.cos(ang) * r + 'px';
                const dy = Math.sin(ang) * r + 'px';
                const rot = (Math.random() * 260 - 130) + 'deg';
                s.style.setProperty('--dx', dx);
                s.style.setProperty('--dy', dy);
                s.style.setProperty('--rot', rot);
                s.style.filter = `hue-rotate(${Math.floor(Math.random() * 360)}deg)`;
                app.appendChild(s);
                setTimeout(() => s.remove(), 950);
            }

            // trails
            const trails = 16;
            for (let i = 0; i < trails; i++) {
                const t = document.createElement('div');
                t.className = 'prism-trail';
                t.style.left = x + 'px'; t.style.top = y + 'px';
                const ang = Math.random() * Math.PI * 2;
                const r = 30 + Math.random() * 70;
                t.style.setProperty('--dx', (Math.cos(ang) * r) + 'px');
                t.style.setProperty('--dy', (Math.sin(ang) * r) + 'px');
                app.appendChild(t);
                setTimeout(() => t.remove(), 620);
            }

            // –ª—ë–≥–∫–∞—è ¬´–≤–∏–Ω—å–µ—Ç–∫–∞¬ª –ø–æ–≤–µ—Ä—Ö
            const vg = document.createElement('div');
            vg.className = 'freeze-vignette';
            app.appendChild(vg);
            setTimeout(() => vg.remove(), 260);
        }

        /* === –ú–æ—â–Ω—ã–µ –æ—Å–∫–æ–ª–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ ROMA === */
        function shardsBurst(x, y, n = 24) {
            for (let i = 0; i < n; i++) {
                const d = document.createElement('div');
                d.style.position = 'absolute';
                d.style.left = x + 'px';
                d.style.top = y + 'px';
                d.style.width = 0;
                d.style.height = 0;
                const col = Math.random() < .5 ? '#ffa84d' : '#ffd7b3';
                const s = 10 + Math.random() * 12;
                d.style.borderLeft = `${s}px solid transparent`;
                d.style.borderRight = `${s}px solid transparent`;
                d.style.borderBottom = `${s * 1.6}px solid ${col}`;
                d.style.filter = 'drop-shadow(0 2px 8px rgba(0,0,0,.45))';
                d.style.pointerEvents = 'none';

                const ang = Math.random() * Math.PI * 2;
                const dist = 60 + Math.random() * 140;
                const tx = Math.cos(ang) * dist;
                const ty = Math.sin(ang) * dist * (Math.random() < .4 ? 1.6 : 1.0);

                d.animate([
                    { transform: 'translate(-50%, -50%) rotate(0deg)', opacity: 1 },
                    { transform: `translate(${tx - 50}px, ${ty - 50}px) rotate(${(Math.random() * 360) | 0}deg)`, opacity: 0 }
                ], { duration: 700 + Math.random() * 600, easing: 'cubic-bezier(.2,.7,.2,1)', fill: 'forwards' });

                app.appendChild(d);
                setTimeout(() => d.remove(), 1400);
            }
        }

        /* === –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ (localStorage) === */
        const LB_KEY = 'ec_leaderboard_v1';
        function loadScores() {
            try { return JSON.parse(localStorage.getItem(LB_KEY) || '[]'); } catch { return []; }
        }
        function saveScore(name, score) {
            const arr = loadScores();
            arr.push({ name: String(name || 'Go≈õƒá').slice(0, 16), score: Number(score) || 0, ts: Date.now() });
            arr.sort((a, b) => b.score - a.score);
            const top = arr.slice(0, 5);
            localStorage.setItem(LB_KEY, JSON.stringify(top));
            return top;
        }
        function renderLeaderboardHTML(list) {
            list = (list || []).slice(0, 5); 
            if (!list.length) return '<p class="text-muted" style="text-align:center">Brak wynik√≥w ‚Äî bƒÖd≈∫ pierwszy!</p>';
            const rows = list.map((it, i) =>
                `<tr>
                   <td style="padding:6px 10px">${i + 1}</td>
                   <td style="padding:6px 10px">${it.name}</td>
                   <td style="padding:6px 10px; text-align:right">${zl(it.score)}</td>
                 </tr>`
            ).join('');
            return `
                <div style="margin-top:12px">
                  <h3 style="margin:8px 0 6px 0">üèÜ Tablica wynik√≥w</h3>
                  <table style="width:100%; border-collapse:collapse; font-weight:600; background:#141414; border:1px solid #222; border-radius:12px; overflow:hidden">
                    <thead>
                      <tr style="background:#191919">
                        <th style="text-align:left; padding:6px 10px; width:50px">#</th>
                        <th style="text-align:left; padding:6px 10px">Imiƒô</th>
                        <th style="text-align:right; padding:6px 10px">Wynik</th>
                      </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                  </table>
                </div>
            `;
        }

        /* ========= SLOW-MO –ª–æ–≥–∏–∫–∞ ========= */
        let slowmoTimerId = null;
        function enterSlowmo(ms = 3000) {
            app.classList.add('slowmo');
            try { if (navigator.vibrate) navigator.vibrate([40, 60, 40]); } catch { }
            if (slowmoTimerId) { clearTimeout(slowmoTimerId); slowmoTimerId = null; }
            slowmoTimerId = setTimeout(exitSlowmo, ms);
        }
        function exitSlowmo() {
            app.classList.remove('slowmo');
            if (slowmoTimerId) { clearTimeout(slowmoTimerId); slowmoTimerId = null; }
        }

        /* ========= –°—á—ë—Ç ========= */
        function update() {
            const cap = CONFIG.game.cap;
            if (discount < 0) discount = 0;
            if (discount > cap) discount = cap;
            dEl.textContent = zl(discount);
        }

        /* ========= –ü–∞–¥–µ–Ω–∏–µ ========= */
        function fallSetup(el, { allowEvade = true, allowSwim = true, size = 56, customDur = null } = {}) {
            const G = CONFIG.game;
            el.style.left = rand(0, app.clientWidth - size) + 'px';
            if (Math.random() < 0.25) el.style.setProperty('--rot', (Math.random() < 0.5 ? -1 : 1) * rand(120, 360) + 'deg');

            // –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            const dur = (customDur ?? rand(G.fallMin, G.fallMax));

            el.style.top = '-80px';
            el.style.setProperty('--fallDur', dur + 'ms');
            el.style.animation = 'fall ' + dur + 'ms linear forwards';
            el.addEventListener('animationend', () => el.remove(), { once: true });

            if (allowSwim && Math.random() < G.chSwim) {
                const amp = 16 + Math.random() * 20, freq = 0.5 + Math.random() * 0.7, vel = (Math.random() < 0.5 ? -1 : 1) * (8 + Math.random() * 20);
                const x0 = parseFloat(el.style.left) || 0, start = performance.now();
                (function swim() {
                    if (!el.isConnected) return; const t = (performance.now() - start) / 1000;
                    const nx = x0 + vel * t + amp * Math.sin(2 * Math.PI * freq * t); el.style.left = clamp(nx, 0, app.clientWidth - size) + 'px'; el.__swim = requestAnimationFrame(swim);
                })();
                el.addEventListener('animationend', () => cancelAnimationFrame(el.__swim || 0), { once: true });
            }
            if (allowEvade) {
                const tryEvade = () => { if (Math.random() < G.chEvade) { vibr(12); const x = (parseFloat(el.style.left) || 0) + (Math.random() < 0.5 ? -1 : 1) * rand(110, 180); el.style.left = clamp(x, 0, app.clientWidth - size) + 'px'; } };
                el.addEventListener('pointerdown', tryEvade); el.addEventListener('pointerenter', tryEvade);
            }
            app.appendChild(el);
        }

        /* ========= –§–∞–±—Ä–∏–∫–∏ ========= */
        const svgToDataUri = svg => "data:image/svg+xml;utf8," + encodeURIComponent(svg);

        function makeNormal() {
            const N = CONFIG.elements.normal;
            const idx = Math.floor(Math.random() * N.items.length);
            const pick = N.items[idx] || { src: '', size: 56 };
            const img = new Image(); img.decoding = 'async'; img.loading = 'eager';
            img.src = pick.src || svgToDataUri(N.fallbackSvg);
            img.onerror = () => { img.onerror = null; img.src = svgToDataUri(N.fallbackSvg); };
            const key = SND[`el.normal.${idx}`] ? `el.normal.${idx}` : (SND['el.normal'] ? 'el.normal' : 'hit');
            return { el: img, size: pick.size || 56, reward: N.reward, allowEvade: N.allowEvade, allowSwim: N.allowSwim, soundKey: key };
        }
        function makeSuper() {
            const S = CONFIG.elements.super;
            const img = new Image(); img.decoding = 'async'; img.loading = 'eager';
            img.src = S.src || svgToDataUri(S.fallbackSvg);
            img.onerror = () => { img.onerror = null; img.src = svgToDataUri(S.fallbackSvg); };
            const key = SND['el.super'] ? 'el.super' : 'hit';
            return { el: img, size: S.size, reward: S.reward, allowEvade: S.allowEvade, allowSwim: S.allowSwim, soundKey: key };
        }
        function makeBig() {
            const B = CONFIG.elements.big;
            const img = new Image(); img.decoding = 'async'; img.loading = 'eager'; img.src = B.src || '';
            const key = SND['el.big'] ? 'el.big' : 'hit';
            return { el: img, size: B.size, reward: B.reward, allowEvade: B.allowEvade, allowSwim: B.allowSwim, soundKey: key };
        }
        function makeBomb() {
            const B = CONFIG.elements.bomb; let node, isImage = false;
            if (B.imageSrc) { const img = new Image(); img.decoding = 'async'; img.loading = 'eager'; img.src = B.imageSrc; node = img; isImage = true; }
            else { const div = document.createElement('div'); div.className = 'bomb'; div.textContent = B.icon || 'üí£'; node = div; }
            const key = SND['el.bomb'] ? 'el.bomb' : 'bomb';
            return { el: node, size: B.size, reward: B.reward, allowEvade: B.allowEvade, allowSwim: B.allowSwim, isImage, soundKey: key };
        }
        function makeTornado() {
            const T = CONFIG.elements.tornado;
            const div = document.createElement('div'); div.className = 'tornado';
            if (T.src) { const img = new Image(); img.src = T.src; img.style.width = (T.size - 8) + 'px'; img.style.height = (T.size - 8) + 'px'; img.style.pointerEvents = 'none'; img.onerror = () => img.remove(); div.appendChild(img); }
            const key = SND['el.tornado'] ? 'el.tornado' : 'tornado';
            return { el: div, size: T.size, reward: T.reward, allowEvade: T.allowEvade, allowSwim: T.allowSwim, soundKey: key };
        }
        function makeRoma() {
            const R = CONFIG.elements.roma;
            const img = new Image(); img.decoding = 'async'; img.loading = 'eager';
            img.src = R.src || svgToDataUri(R.fallbackSvg);
            img.onerror = () => { img.onerror = null; img.src = svgToDataUri(R.fallbackSvg); };
            const key = SND['el.roma'] ? 'el.roma' : (SND['el.super'] ? 'el.super' : 'hit');
            return { el: img, size: R.size, reward: R.reward, allowEvade: R.allowEvade, allowSwim: R.allowSwim, soundKey: key };
        }

        /* ========= –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü-–æ–±—ä–µ–∫—Ç–æ–≤ ========= */
        let tickNo = 0;            // —Ç–µ–∫—É—â–∏–π –Ω–æ–º–µ—Ä —Ç–∏–∫–∞ —Å–ø–∞–≤–Ω–∞
        let superTick = null;      // –∫–æ–≥–¥–∞ –ø–æ–∫–∞–∑–∞—Ç—å —Å—É–ø–µ—Ä-—Å–ª–æ–Ω–∞
        let bigTicks = new Set();  // –∫–æ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å big
        let romaCount = 0;         // —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∑–∞—Å–ø–∞–≤–Ω–µ–Ω –†–æ–º–∞
        let romaTick = null;       // –∫–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è –†–æ–º–∞
        const randi = (a, b) => Math.floor(Math.random() * (b - a + 1)) + a;

        function planSpecials() {
            const totalTicks = Math.floor(CONFIG.game.duration / CONFIG.game.spawnInterval);

            // –æ–∫–Ω–∞ –ø–æ—è–≤–ª–µ–Ω–∏—è (–¥–æ–ª–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ä–∞—É–Ω–¥–∞)
            const superWin = [0.35, 0.85];
            const bigWin = [0.15, 0.95];
            const minGapMs = 2500; // –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∑–∞–∑–æ—Ä –º–µ–∂–¥—É –±–∏–≥–∞–º–∏/—Å—É–ø–µ—Ä–æ–º
            const minGapTicks = Math.ceil(minGapMs / CONFIG.game.spawnInterval);

            superTick = randi(
                Math.floor(totalTicks * superWin[0]),
                Math.floor(totalTicks * superWin[1])
            );

            bigTicks.clear();
            const want = CONFIG.elements.big.maxPerGame || 0;
            const minT = Math.floor(totalTicks * bigWin[0]);
            const maxT = Math.floor(totalTicks * bigWin[1]);

            while (bigTicks.size < want && (maxT - minT + 1) > 0) {
                const t = randi(minT, maxT);
                let ok = Math.abs(t - superTick) >= minGapTicks;
                if (ok) for (const bt of bigTicks) { if (Math.abs(t - bt) < minGapTicks) { ok = false; break; } }
                if (ok) bigTicks.add(t);
            }

            // --- ROMA –æ–∫–Ω–æ –ø–æ—è–≤–ª–µ–Ω–∏—è (–ø–æ—Å–ª–µ 40% –≤—Ä–µ–º–µ–Ω–∏ –∏ –¥–æ ~88%) ---
            const romaWin = [0.40, 0.88];
            const minGapTicksAll = Math.ceil(2500 / CONFIG.game.spawnInterval);
            romaTick = randi(
                Math.floor(totalTicks * romaWin[0]),
                Math.floor(totalTicks * romaWin[1])
            );
            let tries = 40;
            while (tries-- > 0) {
                let ok = Math.abs(romaTick - superTick) >= minGapTicksAll;
                if (ok) for (const bt of bigTicks) { if (Math.abs(romaTick - bt) < minGapTicksAll) { ok = false; break; } }
                if (ok) break;
                romaTick = randi(
                    Math.floor(totalTicks * romaWin[0]),
                    Math.floor(totalTicks * romaWin[1])
                );
            }
        }

        /* ========= –°–ø–∞–≤–Ω ========= */
        function spawn() {
            if (!running) return;
            const E = CONFIG.elements;

            // –Ω–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ —Ç–∏–∫–∞
            const cur = tickNo++;

            // --- ROMA –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é: –æ–¥–∏–Ω —Ä–∞–∑ –∑–∞ —Ä–∞—É–Ω–¥
            if (E.roma?.maxPerGame && romaCount < (E.roma.maxPerGame || 1) && cur === romaTick) {
                romaCount++; spawnRoma(); return;
            }

            // —Å–ø–µ—Ü-–æ–±—ä–µ–∫—Ç—ã –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
            if (E.super.maxPerGame && superCount < (E.super.maxPerGame || 1) && cur === superTick) {
                superCount++; spawnSuper(); return;
            }
            if (bigTicks.size && bigTicks.has(cur) && bigCount < (E.big.maxPerGame || 0)) {
                bigCount++; spawnBig(); return;
            }

            // –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω–æ
            const r = Math.random();
            if (r < (E.bomb.chance || 0)) { spawnBomb(); return; }
            if (r < (E.bomb.chance || 0) + (E.tornado.chance || 0)) { spawnTornado(); return; }
            spawnNormal();
        }

        /* ========= –°—É—â–Ω–æ—Å—Ç–∏ ========= */
        function spawnNormal() {
            const n = makeNormal(); n.el.className = 'logo';
            fallSetup(n.el, { allowEvade: n.allowEvade, allowSwim: n.allowSwim, size: n.size });
            n.el.addEventListener('pointerdown', e => {
                play(n.soundKey || 'hit'); vibr(CONFIG.vib.normal);
                onHit(n.reward, zl(n.reward))(e);
            }, { once: true });
        }
        function spawnSuper() {
            const s = makeSuper(); s.el.className = 'super';
            fallSetup(s.el, { allowEvade: s.allowEvade, allowSwim: s.allowSwim, size: s.size });
            s.el.addEventListener('pointerdown', e => {
                play(s.soundKey || 'hit'); vibr(CONFIG.vib.super + CRIT_VIB);
                onHit(s.reward, zl(s.reward))(e);
                critCelebrate(e.clientX, e.clientY, '+' + zl(s.reward));
            }, { once: true });
        }
        function spawnBig() {
            const b = makeBig(); b.el.className = 'big';
            fallSetup(b.el, { allowEvade: b.allowEvade, allowSwim: b.allowSwim, size: b.size });
            b.el.addEventListener('pointerdown', e => {
                play(b.soundKey || 'hit'); vibr(CONFIG.vib.normal + 10);
                onHit(b.reward, zl(b.reward))(e);
            }, { once: true });
        }
        function spawnBomb() {
            const b = makeBomb(); if (!b.isImage) b.el.classList.add('bomb');
            fallSetup(b.el, { allowEvade: b.allowEvade, allowSwim: b.allowSwim, size: b.size });
            b.el.addEventListener('pointerdown', e => {
                play(b.soundKey || 'bomb'); vibr(CONFIG.vib.bomb);
                boom(e.clientX, e.clientY); shake(); onHit(b.reward, '')(e);
            }, { once: true });
        }
        function spawnTornado() {
            const t = makeTornado(); t.el.className = 'tornado';
            fallSetup(t.el, { allowEvade: t.allowEvade, allowSwim: t.allowSwim, size: t.size });
            t.el.addEventListener('pointerdown', e => {
                play(t.soundKey || 'tornado'); vibr(CONFIG.elements.tornado.vibr);
                twistBurst(e.clientX, e.clientY, 10); vortex(e.clientX, e.clientY); windGust();
                pullNearby(e.clientX, e.clientY, CONFIG.elements.tornado.pull);
                onHit(t.reward, '')(e);
            }, { once: true });
        }
        function spawnRoma() {
            const r = makeRoma(); r.el.className = 'roma';

            // –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –ø–∞–¥–µ–Ω–∏—è ROMA
            const frMin = CONFIG.elements.roma.fallMin || CONFIG.game.fallMin;
            const frMax = CONFIG.elements.roma.fallMax || CONFIG.game.fallMax;
            const dur = rand(frMin, frMax);

            fallSetup(r.el, { allowEvade: r.allowEvade, allowSwim: r.allowSwim, size: r.size, customDur: dur });

            // –Ω–æ–≤—ã–π FX + —É—Å–∏–ª–µ–Ω–Ω—ã–µ –æ—Å–∫–æ–ª–∫–∏
            r.el.addEventListener('pointerdown', e => {
                play(r.soundKey || 'hit'); vibr([30, 50, 30]);
                shardsBurst(e.clientX, e.clientY, 28);    // –º–æ—â–Ω—ã–µ –æ—Å–∫–æ–ª–∫–∏
                romaPrismFX(e.clientX, e.clientY);        // –ø—Ä–∏–∑–º–∞—Ç–∏—á–µ—Å–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç
                shake();                                   // —Ç—Ä—è—Å–∫–∞ –∫–∞–º–µ—Ä—ã
                enterSlowmo(3000);                         // 3 —Å–µ–∫ —Å–ª–æ—É–º–æ
                e.currentTarget.remove();
            }, { once: true });
        }

        /* === –ü—Ä–∏—Ç—è–∂–µ–Ω–∏–µ –∫ —Ç–æ—Ä–Ω–∞–¥–æ === */
        function pullNearby(x, y, { radius = 220, strength = 60, dur = 620 } = {}) {
            const start = performance.now();
            const elems = Array.from(document.querySelectorAll('.logo,.super,.big'));
            const meta = elems.map(el => { const r = el.getBoundingClientRect(); return { el, w: r.width, h: r.height }; });
            function step(now) {
                const t = Math.min(1, (now - start) / dur);
                const ease = t < .5 ? (2 * t * t) : (-1 + (4 - 2 * t) * t);
                meta.forEach(({ el, w }) => {
                    if (!el.isConnected) return;
                    const r = el.getBoundingClientRect(), cx = r.left + r.width / 2, cy = r.top + r.height / 2;
                    const dx = x - cx, dy = y - cy, dist = Math.hypot(dx, dy); if (dist > radius) return;
                    const k = (1 - dist / radius) * strength * ease;
                    const curLeft = parseFloat(el.style.left) || 0;
                    const nx = curLeft + (dx / (dist || 1)) * k;
                    el.style.left = clamp(nx, 0, app.clientWidth - w) + 'px';
                    const curRot = parseFloat(getComputedStyle(el).getPropertyValue('--rot')) || 0;
                    el.style.setProperty('--rot', (curRot + (dx > 0 ? 8 : -8) * ease) + 'deg');
                });
                if (t < 1) requestAnimationFrame(step);
            }
            requestAnimationFrame(step);
        }

        /* === –ü–æ–ø–∞–¥–∞–Ω–∏–µ === */
        function onHit(delta, label) {
            return e => {
                if (!running) return;
                discount += delta; update();
                const p = { x: e?.clientX || 0, y: e?.clientY || 0 };
                if (delta > 0) celebrate(p.x, p.y, '+' + label);
                e.currentTarget.remove();
            };
        }

        /* === –¢–∞–π–º–µ—Ä/—Ä–∞—É–Ω–¥ === */
        function tick(now) {
            const left = (CONFIG.game.duration - (now - t0)) / 1000;
            tEl.textContent = Math.max(0, left).toFixed(1);
            if (left > 0) requestAnimationFrame(tick); else endGame();
        }
        function clearField() {
            document.querySelectorAll('.logo,.super,.big,.tornado,.bomb,.roma,.sheet,.ring,.confetti,.float,.boom,.crit-flash,.crit-burst,.crit-ray,.twist,.vortex').forEach(n => n.remove());
        }
        function startGame() {
            running = false; if (spawnTimer) clearInterval(spawnTimer);
            clearField(); discount = 0; superCount = 0; bigCount = 0; romaCount = 0; exitSlowmo(); update();
            startOv.style.display = 'none';

            // –ø–ª–∞–Ω –Ω–∞ —Ä–∞—É–Ω–¥
            tickNo = 0;
            planSpecials();

            running = true; t0 = performance.now();
            spawnTimer = setInterval(spawn, CONFIG.game.spawnInterval);
            if (CONFIG.sounds.enabled && bgMusic) { try { bgMusic.currentTime = 0; bgMusic.play(); } catch { } }
            requestAnimationFrame(tick);
        }

        /* === –ö–æ–Ω–µ—Ü –∏–≥—Ä—ã + –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ === */
        function endGame() {
            running = false; clearInterval(spawnTimer);
            const final = Math.round(discount);
            const s = document.createElement('div'); s.className = 'sheet';
            const currentLB = loadScores();

            s.innerHTML =
                `<div style="text-align:center">
                    <h2>Koniec!</h2>
                    <p>Tw√≥j rabat: <b>${zl(final)}</b></p>
                    <p style="opacity:.9;margin-top:12px">Zr√≥b zrzut ekranu i <b>wy≈õlij nam w wiadomo≈õci</b>.</p>


                    <div style="margin:12px 0 6px">
                      <input id="lbName" type="text" maxlength="16" placeholder="Twoje imiƒô"
                             style="width: 220px; padding:10px 12px; border-radius:10px; border:1px solid #333; background:#0f0f0f; color:#fff; font-weight:700"/>
                      <button class="btn" id="saveScore" style="margin-left:8px">Zapisz</button>
                      <p style="opacity:.9;margin-top:12px">Max 5 os√≥b</b>.</p>
                    </div>

                    <div id="lbBox">${renderLeaderboardHTML(currentLB)}</div>

                    <br>
                    <button class="btn" id="again">Jeszcze raz</button>
                 </div>`;

            document.body.appendChild(s);

            s.querySelector('#saveScore').onclick = () => {
                const name = s.querySelector('#lbName').value.trim() || 'Go≈õƒá';
                const top = saveScore(name, final);
                s.querySelector('#lbBox').innerHTML = renderLeaderboardHTML(top);
            };
            s.querySelector('#again').onclick = () => { s.remove(); startOv.style.display = 'flex'; };
        }

        document.getElementById('start').addEventListener('pointerdown', startGame);
    </script>
</body>

</html>